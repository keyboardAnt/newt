#!/bin/bash
# Auto-generated eval script for tasks needing videos
# Generated: 2025-12-27T06:50:20.337136
# Tasks: 3

#BSUB -J newt-eval-videos[1-3]
#BSUB -q short-gpu
#BSUB -n 1
#BSUB -gpu "num=1:mode=exclusive_process"
#BSUB -R "rusage[mem=16GB,tmp=10240]"  # tmp is MB; 10240 ~= 10 GiB
#BSUB -W 04:00
#BSUB -o /home/projects/dharel/nadavt/repos/newt/tdmpc2/logs/lsf/newt-eval-videos.%J.%I.log
#BSUB -e /home/projects/dharel/nadavt/repos/newt/tdmpc2/logs/lsf/newt-eval-videos.%J.%I.log

#BSUB -app nvidia-gpu
#BSUB -env "LSB_CONTAINER_IMAGE=ops:5000/newt:1.0.2"

cd /home/projects/dharel/nadavt/repos/newt/tdmpc2

pip install -q "wandb[media]"

TASK=$(sed -n "${LSB_JOBINDEX}p" jobs/tasks_need_eval.txt)
echo "LSF job index: ${LSB_JOBINDEX}, task: ${TASK}"

export TASK
eval $(python - <<'PY'
import os, yaml
from pathlib import Path
from discover.progress import parse_step

task = os.environ.get("TASK", "")
logs_dir = Path("logs")
run_info_paths = []
for pat in ("*/run_info.yaml", "*/*/run_info.yaml", "*/*/*/run_info.yaml"):
    run_info_paths.extend(logs_dir.glob(pat))

candidates = []
for run_info_path in run_info_paths:
    run_dir = run_info_path.parent
    info = yaml.safe_load(run_info_path.read_text()) or {}
    tasks = info.get("tasks", [info.get("task")])
    if task in tasks:
        for ckpt in (run_dir / "checkpoints").glob("*.pt"):
            if not ckpt.stem.endswith('_trainer'):
                candidates.append(ckpt)
if not candidates:
    print('CKPT=')
    print('RUN_ID=')
else:
    best = max(candidates, key=parse_step)
    run_id = best.parent.parent.name
    print(f'CKPT="{best.resolve()}"')
    print(f'RUN_ID="{run_id}"')
PY
)

if [ -z "${CKPT}" ]; then
  echo "No checkpoint found for task '${TASK}', skipping."
  exit 0
fi

echo "Evaluating checkpoint: ${CKPT}"

python train.py \
  task="${TASK}" \
  model_size=B \
  checkpoint="${CKPT}" \
  steps=1 \
  eval_only=True \
  num_envs=2 \
  use_demos=False \
  tasks_fp=/home/projects/dharel/nadavt/repos/newt/tasks.json \
  exp_name="eval_${RUN_ID}" \
  save_video=True \
  env_mode=sync \
  compile=False  # Keep disabled for eval (compilation overhead > 1-step runtime)
